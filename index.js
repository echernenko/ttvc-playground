const http = require('http');
const ttvcFile = `
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TTVC={})}(this,(function(e){"use strict";const t={DEBUG:!1,IDLE_TIMEOUT:200,NETWORK_TIMEOUT:6e4};class i{static format(...e){return["[ttvc]",...e,"::",performance.now()]}static debug(...e){t.DEBUG&&console.debug(...this.format(...e))}static info(...e){t.DEBUG&&console.info(...this.format(...e))}static warn(...e){t.DEBUG&&console.warn(...this.format(...e))}}class s{constructor(){this.pendingRequests=0,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("AjaxIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===t.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{i.warn("AjaxIdleObservable","::","Timed out waiting for requests to resolve.","Make sure that incrementAjaxCount() is always matched with decrementAjaxCount().","::","pendingRequests =",this.pendingRequests),this.didNetworkTimeOut=!0,this.pendingRequests=0,this.next("IDLE")}),t.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.increment=()=>{this.startCleanupTimeout(),0===this.pendingRequests&&this.next("BUSY"),this.pendingRequests+=1},this.decrement=()=>{this.abortCleanupTimeout(),1===this.pendingRequests?this.next("IDLE"):this.startCleanupTimeout(),this.pendingRequests=Math.max(this.pendingRequests-1,0),this.pendingRequests<10&&i.debug("AjaxIdleObservable.decrement()","::","pendingRequests =",this.pendingRequests)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}}}}class n{constructor(){this.pendingResources=new Set,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{i.debug("ResourceLoadingIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{if(0===t.NETWORK_TIMEOUT)return;this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{i.warn("ResourceLoadingIdleObservable","::","Timed out waiting for resources to resolve.","Consider filing a bug report if this continues to occur.","::","pendingResources =",this.pendingResources),this.didNetworkTimeOut=!0,this.pendingResources=new Set,this.next("IDLE")}),t.NETWORK_TIMEOUT)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.add=e=>{e instanceof HTMLImageElement&&!e.src||e instanceof HTMLImageElement&&e.complete||e instanceof HTMLLinkElement&&!e.href||e instanceof HTMLScriptElement&&!e.src||e instanceof HTMLIFrameElement&&(!e.src||"about:blank"===e.src)||(this.startCleanupTimeout(),0===this.pendingResources.size&&this.next("BUSY"),this.pendingResources.add(e))},this.remove=e=>{this.abortCleanupTimeout(),this.pendingResources.delete(e),0===this.pendingResources.size?this.next("IDLE"):this.startCleanupTimeout(),this.pendingResources.size<10&&i.debug("ResourceLoadingIdleObservable.remove()","::","pendingResources =",this.pendingResources)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},"undefined"!=typeof window&&(null===window||void 0===window?void 0:window.MutationObserver)&&window.addEventListener("load",(()=>{new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e instanceof HTMLScriptElement||e instanceof HTMLLinkElement||e instanceof HTMLImageElement||e instanceof HTMLIFrameElement?this.add(e):e.hasChildNodes()&&e instanceof HTMLElement&&e.querySelectorAll("img").forEach(this.add)}))}))})).observe(window.document.documentElement,{childList:!0,subtree:!0}),["load","error"].forEach((e=>{window.document.addEventListener(e,(e=>{(e.target instanceof HTMLScriptElement||e.target instanceof HTMLLinkElement||e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&this.remove(e.target)}),{capture:!0})}))}))}}class r{constructor(){this.ajaxIdleObservable=new s,this.resourceLoadingIdleObservable=new n,this.subscribers=new Set,this.ajaxIdle=!0,this.scriptLoadingIdle=!0,this.handleUpdate=e=>t=>{const i=this.ajaxIdle&&this.scriptLoadingIdle;"AJAX"===e&&(this.ajaxIdle="IDLE"===t),"RESOURCE_LOADING"===e&&(this.scriptLoadingIdle="IDLE"===t);const s=this.ajaxIdle&&this.scriptLoadingIdle;i!==s&&this.next(s?"IDLE":"BUSY")},this.next=e=>{i.debug("NetworkIdleObservable.next()",e),this.subscribers.forEach((t=>t(e)))},this.incrementAjaxCount=()=>this.ajaxIdleObservable.increment(),this.decrementAjaxCount=()=>this.ajaxIdleObservable.decrement(),this.isIdle=()=>this.ajaxIdle&&this.scriptLoadingIdle,this.didNetworkTimeOut=()=>this.ajaxIdleObservable.didNetworkTimeOut||this.resourceLoadingIdleObservable.didNetworkTimeOut,this.resetDidNetworkTimeOut=()=>{this.ajaxIdleObservable.didNetworkTimeOut=!1,this.resourceLoadingIdleObservable.didNetworkTimeOut=!1},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},this.ajaxIdleObservable.subscribe(this.handleUpdate("AJAX")),this.resourceLoadingIdleObservable.subscribe(this.handleUpdate("RESOURCE_LOADING"))}}let o;const a=()=>(o||(o=new r),o);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function d(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{d(s.next(e))}catch(e){r(e)}}function a(e){try{d(s.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}d((s=s.apply(e,t||[])).next())}))}class l{constructor(e){this.mutationObserverConfig={attributeFilter:["hidden","style","src"],attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},this.mutations=new Map,this.mutationObserverCallback=e=>{i.debug("InViewportMutationObserver.mutationObserverCallback()","::","mutations =",e),e.forEach((e=>{e.timestamp=performance.now();let t=null;if(e.target instanceof Element&&(t=e.target),e.target instanceof Text&&(t=e.target.parentElement),t)if("childList"===e.type)e.addedNodes.forEach((t=>{t instanceof HTMLElement&&(this.intersectionObserver.observe(t),this.mutations.set(t,e)),t instanceof Text&&null!=t.parentElement&&(this.intersectionObserver.observe(t.parentElement),this.mutations.set(t.parentElement,e))}));else this.intersectionObserver.observe(t),this.mutations.set(t,e)}))},this.intersectionObserverCallback=e=>{i.debug("InViewportMutationObserver.intersectionObserverCallback()","::","entries =",e),e.forEach((e=>{const t=this.mutations.get(e.target);e.isIntersecting&&null!=t&&(i.info("InViewportMutationObserver.callback()","::","mutation =",t),this.callback(t)),this.mutations.delete(e.target),this.intersectionObserver.unobserve(e.target)}))},this.callback=e,this.mutationObserver=new MutationObserver(this.mutationObserverCallback),this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(e){i.info("InViewportMutationObserver.observe()","::","target =",e),this.mutationObserver.observe(e,this.mutationObserverConfig)}disconnect(){i.info("InViewportMutationObserver.disconnect()"),this.mutationObserver.disconnect(),this.intersectionObserver.disconnect()}}function c(e){const s=a();let n,r=s.isIdle();const o=e=>{r="IDLE"===e,r?(e=>{var t;(null!==(t=window.requestIdleCallback)&&void 0!==t?t:window.setTimeout)((()=>{window.requestAnimationFrame((()=>window.requestAnimationFrame(e)))}))})(d):(window.clearTimeout(n),n=void 0)},d=()=>{i.debug("requestAllIdleCallback.handleCpuIdle()"),r&&!n&&l()},l=()=>{n=window.setTimeout((()=>{const t=s.didNetworkTimeOut();s.resetDidNetworkTimeOut(),i.info("requestAllIdleCallback: ALL IDLE"),e(t),c()}),t.IDLE_TIMEOUT)},c=s.subscribe(o);r&&o("IDLE")}class u{constructor(e){this.imageLoadTimes=new Map,this.lastImageLoadTimestamp=0,this.intersectionObserverCallback=e=>{e.forEach((e=>{const t=e.target,s=this.imageLoadTimes.get(t);e.isIntersecting&&null!=s&&(i.info("InViewportImageObserver.callback()","::","timestamp =",s),this.callback(s,t)),this.intersectionObserver.unobserve(t),this.imageLoadTimes.delete(t)}))},this.handleLoadOrErrorEvent=e=>{(e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&(i.debug("InViewportImageObserver.handleLoadOrErrorEvent()","::","event =",e),this.imageLoadTimes.set(e.target,e.timeStamp),this.intersectionObserver.observe(e.target))},this.callback=e,this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback)}observe(){i.info("InViewportImageObserver.observe()"),document.addEventListener("load",this.handleLoadOrErrorEvent,{capture:!0}),document.addEventListener("error",this.handleLoadOrErrorEvent,{capture:!0})}disconnect(){i.info("InViewportImageObserver.disconnect()"),this.lastImageLoadTimestamp=0,this.imageLoadTimes.clear(),this.intersectionObserver.disconnect(),document.removeEventListener("load",this.handleLoadOrErrorEvent),document.removeEventListener("error",this.handleLoadOrErrorEvent)}}const h=()=>{var e;return(null===(e=window.performance.getEntriesByType("navigation")[0])||void 0===e?void 0:e.type)||(()=>{const e=window.performance.navigation.type;return 2===e?"back_forward":1===e?"reload":"navigate"})()};class m{constructor(){if(this.debug=!1,this.idleTimeout=200,this.lastImageLoadTimestamp=-1,this.navigationCount=0,this.observations=new Map,this.successSubscribers=new Set,this.errorSubscribers=new Set,this.onTTVC=(e,t)=>(this.successSubscribers.add(e),t&&this.errorSubscribers.add(t),()=>{this.successSubscribers.delete(e),t&&this.errorSubscribers.delete(t)}),!m.isSupportedEnvironment())throw new Error("VisuallyCompleteCalculator: This browser/runtime is not supported.");this.inViewportMutationObserver=new l((e=>{var t,i,s;(null!==(t=e.timestamp)&&void 0!==t?t:0)>=(null!==(s=null===(i=this.lastMutation)||void 0===i?void 0:i.timestamp)&&void 0!==s?s:0)&&(this.lastMutation=e)})),this.inViewportImageObserver=new u(((e,t)=>{e>=this.lastImageLoadTimestamp&&(this.lastImageLoadTimestamp=e,this.lastImageLoadTarget=t)}))}static isSupportedEnvironment(){var e;return void 0!==window&&"MutationObserver"in window&&"IntersectionObserver"in window&&"function"==typeof document.querySelectorAll&&(null===(e=window.performance)||void 0===e?void 0:e.timing)}cancel(e){const t=this.observations.get(this.observations.size);t&&"ACTIVE"===t.state&&(t.cancel("MANUAL_CANCELLATION",e),t.state="CANCELLED")}start(e=0,t=!1){var s,n;return d(this,void 0,void 0,(function*(){const r=this.navigationCount+=1;i.info("VisuallyCompleteCalculator.start()","::","index =",r);const o=this.observations.get(r-1);o&&"ACTIVE"===o.state&&o.cancel("NEW_MEASUREMENT");let a=t?"back_forward":e>0?"script":h();const d=(()=>{var e;return(null===(e=window.performance.getEntriesByType("navigation")[0])||void 0===e?void 0:e.activationStart)||0})();d>e&&(e=d,a="prerender");const l=(t,i)=>{const s=this.observations.get(r);if(!s||"ACTIVE"!==s.state)return;s.state="CANCELLED";const n=performance.now();this.error(Object.assign({start:e,end:n,duration:n-e,cancellationReason:t,navigationType:a,lastVisibleChange:this.getLastVisibleChange()},i&&{eventType:i.type,eventTarget:i.target||void 0}),s)},u={index:r,state:"ACTIVE",cancel:l};this.observations.set(r,u);const m=e=>l("USER_INTERACTION",e),b=e=>l("NEW_NAVIGATION",e),v=e=>l("VISIBILITY_CHANGE",e);this.inViewportImageObserver.observe(),this.inViewportMutationObserver.observe(document.documentElement),window.addEventListener("pagehide",b),window.addEventListener("visibilitychange",v),window.setTimeout((()=>{window.addEventListener("click",m),window.addEventListener("keydown",m)}),0),yield"complete"===document.readyState?Promise.resolve():new Promise((e=>{const t=()=>{e(),window.removeEventListener("load",t)};window.addEventListener("load",t)}));const w=yield new Promise(c);if("ACTIVE"===u.state){u.state="COMPLETED";const t=Math.max(e,this.lastImageLoadTimestamp,null!==(n=null===(s=this.lastMutation)||void 0===s?void 0:s.timestamp)&&void 0!==n?n:0);this.next({start:e,end:t,duration:t-e,detail:{navigationType:a,didNetworkTimeOut:w,lastVisibleChange:this.getLastVisibleChange()}},u)}else i.debug("VisuallyCompleteCalculator: Measurement discarded","::","index =",r);window.removeEventListener("pagehide",b),window.removeEventListener("visibilitychange",v),window.removeEventListener("click",m),window.removeEventListener("keydown",m),r===this.navigationCount&&(this.inViewportImageObserver.disconnect(),this.inViewportMutationObserver.disconnect())}))}next(e,t){var s,n;e.end>Number.MAX_SAFE_INTEGER?i.warn("VisuallyCompleteCalculator.next()","::","This browser reported a time larger than MAX_SAFE_INTEGER. We are ignoring it.","::",e):(i.debug("VisuallyCompleteCalculator.next()","::","lastImageLoadTimestamp =",this.lastImageLoadTimestamp,"lastMutationTimestamp =",null!==(n=null===(s=this.lastMutation)||void 0===s?void 0:s.timestamp)&&void 0!==n?n:0,"::","index =",t.index),i.info("TTVC:",e,"::","index =",t.index),this.successSubscribers.forEach((t=>t(e))))}error(e,t){i.debug("VisuallyCompleteCalculator.error()","::","cancellationReason =",e.cancellationReason,"::","eventType =",e.eventType||"none","::","index =",t.index),this.errorSubscribers.forEach((t=>t(e)))}getLastVisibleChange(){var e,t;return this.lastImageLoadTimestamp>(null!==(t=null===(e=this.lastMutation)||void 0===e?void 0:e.timestamp)&&void 0!==t?t:0)?this.lastImageLoadTarget:this.lastMutation}}let b;let v;e.cancel=e=>null==v?void 0:v.cancel(e),e.decrementAjaxCount=()=>a().decrementAjaxCount(),e.incrementAjaxCount=()=>a().incrementAjaxCount(),e.init=e=>{var s;(e=>{(null==e?void 0:e.debug)&&(t.DEBUG=e.debug),(null==e?void 0:e.idleTimeout)&&(t.IDLE_TIMEOUT=e.idleTimeout),(null==e?void 0:e.networkTimeout)&&(t.NETWORK_TIMEOUT=e.networkTimeout)})(e),i.info("init()"),a(),b||(b=new m),v=b,s=()=>{v.start(),window.addEventListener("locationchange",(e=>{v.start(e.timeStamp)})),window.addEventListener("pageshow",(e=>{e.persisted&&v.start(e.timeStamp,!0)}))},document.prerendering?window.addEventListener("prerenderingchange",s,!0):s()},e.onTTVC=(e,t)=>null==v?void 0:v.onTTVC(e,t),e.start=()=>null==v?void 0:v.start(performance.now()),Object.defineProperty(e,"__esModule",{value:!0})}));
`;

const hostname = 'localhost';
const port = 3000;
const server = http.createServer((req, res) => {
 console.log(req.headers);
 res.statusCode = 200;

 res.end(`<html>
    <head>
      <script>${ttvcFile}
      ;window.init = TTVC.init; window.onTTVC = TTVC.onTTVC; 
      init({
        debug: false,
        idleTimeout: 2000,
        networkTimeout: 0,
        });

// Reports the last visible change for each navigation that
// occurs during the life of this document.
const unsubscribe = onTTVC((measurement) => {
  console.log('TTVC:', measurement.duration);
});
      </script>
    </head><body><h1>Hello, World!</h1>
    <img src="https://img.pravda.com/images/doc/d/f/df206de-rozshifruvati-pozazemniy-signal.avif" />
    <img src="https://imglife.pravda.com.ua/life/images/doc/6/5/78560/6505cbc367614680f5c370376b16f0d7.jpeg?w=770&q=90&f=webp" />
    </body>
    </html>`);
})
server.listen(port, hostname);
